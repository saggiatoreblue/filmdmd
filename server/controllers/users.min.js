var User=require("mongoose").model("User");var crypto=require("../utilities/encryption");exports.getUsers=function(b,a){User.find({}).exec(function(c,d){a.send(d)})};exports.updateUser=function(c,b){var a=c.body;if(c.user._id!=a._id&&!c.user.hasRole("admin")){b.status(403);return b.end()}c.user.firstName=a.firstName;c.user.lastName=a.lastName;c.user.username=a.username;c.user.email=a.email;c.user.rejects=a.rejects;c.user.watched=a.watched;c.user.later=a.later;if(a.password&&a.password.length>0){c.user.salt=crypto.createSalt();c.user.hashed_pwd=crypto.hashPwd(c.user.salt,a.password)}c.user.save(function(d){if(d){b.status(400);return b.send({reason:d.toString()})}b.send(c.user)})};exports.createUser=function(d,b,c){var a=d.body;a.username=a.username.toLowerCase();a.salt=crypto.createSalt();a.hashed_pwd=crypto.hashPwd(a.salt,a.password);User.create(a,function(f,e){if(f){if(f.toString().indexOf("E11000")>-1){f=new Error("Duplicate Username")}b.status(400);return b.send({reason:f.toString()})}d.logIn(e,function(g){if(g){return c(g)}b.send(e)})})};